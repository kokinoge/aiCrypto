<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Money Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--border:rgba(255,255,255,0.06);
  --text:#e8e8ed;--text-s:#8b8b9e;--text-m:#55556a;
  --green:#00d68f;--red:#ff4d6a;--blue:#4d9fff;--purple:#8b5cf6;
  --radius:6px;--ease:cubic-bezier(0.25,1,0.5,1);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'Inter',system-ui,-apple-system,sans-serif;font-size:13px;line-height:1.5;
  -webkit-font-smoothing:antialiased}

.app{display:grid;height:100vh;padding:16px;gap:12px;
  grid-template-rows:auto 1fr 1fr;grid-template-columns:1fr 1fr}

/* Header */
.header{grid-column:1/-1;display:flex;align-items:center;gap:12px;
  padding:10px 16px;background:var(--surface);border:0.5px solid var(--border);border-radius:var(--radius)}
.header-title{font-size:14px;font-weight:600;letter-spacing:-0.02em;display:flex;align-items:center;gap:8px}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--green);
  box-shadow:0 0 6px var(--green);flex-shrink:0}
.status-dot.offline{background:var(--red);box-shadow:0 0 6px var(--red)}
.mode-badge{font-size:11px;font-weight:500;padding:2px 8px;border-radius:4px;
  background:rgba(139,92,246,0.12);color:var(--purple);letter-spacing:0.02em}
.header-right{margin-left:auto;display:flex;align-items:center;gap:16px}
.refresh-info{font-size:11px;color:var(--text-m);font-variant-numeric:tabular-nums}
.updated{font-size:11px;color:var(--text-m)}

/* Stat cards row */
.stats{grid-column:1/-1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat-card{background:var(--surface);border:0.5px solid var(--border);border-radius:var(--radius);padding:16px}
.stat-label{font-size:11px;font-weight:500;color:var(--text-m);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:8px}
.stat-value{font-size:24px;font-weight:700;letter-spacing:-0.03em;font-variant-numeric:tabular-nums;transition:color .2s var(--ease)}
.stat-sub{font-size:11px;color:var(--text-m);margin-top:4px;font-variant-numeric:tabular-nums}
.positive{color:var(--green)}.negative{color:var(--red)}

/* Card */
.card{background:var(--surface);border:0.5px solid var(--border);border-radius:var(--radius);
  display:flex;flex-direction:column;overflow:hidden}
.card-header{padding:12px 16px;border-bottom:0.5px solid var(--border);
  font-size:12px;font-weight:600;color:var(--text-s);letter-spacing:-0.01em;
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.card-body{padding:12px 16px;flex:1;overflow-y:auto;min-height:0}
.card-body::-webkit-scrollbar{width:4px}
.card-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Table */
table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
th{font-size:10px;font-weight:500;color:var(--text-m);text-transform:uppercase;letter-spacing:0.06em;
  text-align:left;padding:6px 8px;border-bottom:0.5px solid var(--border);position:sticky;top:0;background:var(--surface)}
td{padding:8px;font-size:12px;border-bottom:0.5px solid var(--border)}
tr:last-child td{border-bottom:none}
.dir-long{color:var(--green);font-weight:500}.dir-short{color:var(--red);font-weight:500}

/* Trade list */
.trade-item{padding:8px 0;border-bottom:0.5px solid var(--border);display:grid;
  grid-template-columns:auto 1fr auto;gap:4px 8px;align-items:baseline}
.trade-item:last-child{border-bottom:none}
.trade-coin{font-weight:600;font-size:12px}
.trade-side{font-size:10px;font-weight:500}
.trade-meta{font-size:11px;color:var(--text-m);grid-column:2/3}
.trade-pnl{font-size:12px;font-weight:600;font-variant-numeric:tabular-nums;text-align:right}
.trade-date{font-size:10px;color:var(--text-m);text-align:right}

/* Learning section */
.learn-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px}
.learn-stat{text-align:center}
.learn-stat-val{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums}
.learn-stat-label{font-size:10px;color:var(--text-m);margin-top:2px}
.lesson-item{padding:6px 0;border-bottom:0.5px solid var(--border);font-size:11px;color:var(--text-s);line-height:1.4}
.lesson-item:last-child{border-bottom:none}
.lessons-title{font-size:10px;font-weight:500;color:var(--text-m);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px}

/* Agent accuracy */
.agent-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.agent-row:last-child{margin-bottom:0}
.agent-name{font-size:11px;font-weight:500;width:80px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.agent-bar-bg{flex:1;height:6px;background:rgba(255,255,255,0.04);border-radius:3px;overflow:hidden}
.agent-bar{height:100%;border-radius:3px;background:var(--purple);transition:width .4s var(--ease)}
.agent-pct{font-size:11px;font-variant-numeric:tabular-nums;color:var(--text-s);width:36px;text-align:right;flex-shrink:0}
.analysis-box{margin-top:12px;padding:10px 12px;background:rgba(139,92,246,0.06);border:0.5px solid rgba(139,92,246,0.12);
  border-radius:4px;font-size:11px;color:var(--text-s);line-height:1.5}
.analysis-label{font-size:10px;font-weight:500;color:var(--purple);margin-bottom:4px}

/* Empty state */
.empty{display:flex;align-items:center;justify-content:center;height:100%;
  font-size:12px;color:var(--text-m);font-style:italic}

/* Loading */
.loading{opacity:0.5;pointer-events:none}
.skeleton{background:linear-gradient(90deg,var(--border) 25%,rgba(255,255,255,0.08) 50%,var(--border) 75%);
  background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:4px;height:20px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

@media(max-width:900px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .app{grid-template-rows:auto auto repeat(4,1fr);grid-template-columns:1fr;overflow-y:auto}
  .header{grid-column:1}
  .stats{grid-column:1}
}
</style>
</head>
<body>
<div class="app" id="app">

  <header class="header">
    <div class="header-title">
      <span class="status-dot" id="statusDot"></span>
      Smart Money Bot
    </div>
    <span class="mode-badge" id="modeBadge">模擬取引</span>
    <div class="header-right">
      <span class="refresh-info" id="countdown"></span>
      <span class="updated" id="lastUpdated">更新中...</span>
    </div>
  </header>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">資産</div>
      <div class="stat-value" id="equity">—</div>
      <div class="stat-sub" id="cash"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">総損益</div>
      <div class="stat-value" id="pnl">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">リターン</div>
      <div class="stat-value" id="returnPct">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">勝率</div>
      <div class="stat-value" id="winRate">—</div>
      <div class="stat-sub" id="winLoss"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">オープンポジション</div>
    <div class="card-body" id="positions"><div class="empty">ポジションなし</div></div>
  </div>

  <div class="card">
    <div class="card-header">取引履歴</div>
    <div class="card-body" id="trades"><div class="empty">取引履歴なし</div></div>
  </div>

  <div class="card">
    <div class="card-header">学習状況</div>
    <div class="card-body" id="learning">
      <div class="learn-grid">
        <div class="learn-stat"><div class="learn-stat-val" id="ruleCount">0</div><div class="learn-stat-label">アクティブルール</div></div>
        <div class="learn-stat"><div class="learn-stat-val" id="streak">—</div><div class="learn-stat-label">連続記録</div></div>
        <div class="learn-stat"><div class="learn-stat-val" id="sizeMod">1.0x</div><div class="learn-stat-label">サイズ倍率</div></div>
      </div>
      <div class="lessons-title">最近の学習</div>
      <div id="lessons"><div class="empty" style="height:auto;padding:12px 0">学習なし</div></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">AI分析<span class="refresh-info" id="analysisCount"></span></div>
    <div class="card-body" id="analysis"><div class="empty">分析データなし</div></div>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);
const INTERVAL = 30;
let timer = INTERVAL;
let intervalId;

function fmt(n, d = 2) {
  return Number(n).toLocaleString('en-US', { minimumFractionDigits: d, maximumFractionDigits: d });
}

function pnlClass(v) { return v > 0 ? 'positive' : v < 0 ? 'negative' : ''; }

function animateValue(el, newText, colorClass) {
  if (el.textContent === newText && el.className.includes(colorClass || '')) return;
  el.style.transition = 'none';
  el.style.opacity = '0.4';
  requestAnimationFrame(() => {
    el.style.transition = 'opacity .3s var(--ease)';
    el.textContent = newText;
    el.className = 'stat-value ' + (colorClass || '');
    el.style.opacity = '1';
  });
}

function renderPositions(positions) {
  const el = $('positions');
  if (!positions || !positions.length) { el.innerHTML = '<div class="empty">ポジションなし</div>'; return; }
  const rows = positions.map(p => {
    const dirCls = p.side === 'long' ? 'dir-long' : 'dir-short';
    const dirLabel = p.side === 'long' ? 'ロング' : 'ショート';
    const pnlVal = p.unrealized_pnl || p.pnl || 0;
    const pnlPct = p.pnl_pct || 0;
    return `<tr>
      <td style="font-weight:600">${p.symbol || p.coin || '—'}</td>
      <td class="${dirCls}">${dirLabel}</td>
      <td>$${fmt(p.entry_price)}</td>
      <td>$${fmt(p.current_price)}</td>
      <td class="${pnlClass(pnlVal)}" style="font-weight:600">$${fmt(pnlVal)}</td>
      <td class="${pnlClass(pnlPct)}">${fmt(pnlPct)}%</td>
    </tr>`;
  }).join('');
  el.innerHTML = `<table><thead><tr><th>コイン</th><th>方向</th><th>参入価格</th><th>現在価格</th><th>損益</th><th>損益%</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderTrades(trades) {
  const el = $('trades');
  if (!trades || !trades.length) { el.innerHTML = '<div class="empty">取引履歴なし</div>'; return; }
  const items = trades.slice(0, 10).map(t => {
    const pnl = t.pnl || 0;
    const side = t.side === 'long' ? 'ロング' : 'ショート';
    const sideCls = t.side === 'long' ? 'dir-long' : 'dir-short';
    const date = t.closed_at ? new Date(t.closed_at).toLocaleDateString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
    return `<div class="trade-item">
      <span class="trade-coin">${t.symbol || t.coin || '—'}</span>
      <span class="trade-meta"><span class="trade-side ${sideCls}">${side}</span> ${t.reason || ''}</span>
      <span class="trade-pnl ${pnlClass(pnl)}">$${fmt(pnl)}</span>
      <span></span><span></span>
      <span class="trade-date">${date}</span>
    </div>`;
  }).join('');
  el.innerHTML = items;
}

function renderLearning(data) {
  $('ruleCount').textContent = data.active_rules || 0;
  const [streakType, streakN] = data.streak || ['none', 0];
  const streakLabel = streakType === 'win' ? `${streakN}勝` : streakType === 'loss' ? `${streakN}敗` : '—';
  $('streak').textContent = streakLabel;
  $('streak').className = 'learn-stat-val ' + (streakType === 'win' ? 'positive' : streakType === 'loss' ? 'negative' : '');
  $('sizeMod').textContent = (data.position_size_modifier || 1).toFixed(1) + 'x';

  const lessonsEl = $('lessons');
  const lessons = data.lessons || [];
  if (!lessons.length) { lessonsEl.innerHTML = '<div class="empty" style="height:auto;padding:12px 0">学習なし</div>'; return; }
  lessonsEl.innerHTML = lessons.slice(0, 3).map(l => `<div class="lesson-item">${typeof l === 'string' ? l : (l.text || l.rule || JSON.stringify(l))}</div>`).join('');
}

function renderAnalysis(data) {
  const el = $('analysis');
  const acc = data.agent_accuracy || {};
  const agents = Object.entries(acc);
  if (!agents.length && !data.last_decision) { el.innerHTML = '<div class="empty">分析データなし</div>'; return; }

  let html = '';
  if (agents.length) {
    $('analysisCount').textContent = `${agents.length}エージェント`;
    html += agents.map(([name, val]) => {
      const pct = typeof val === 'number' ? val : (val.accuracy || val.score || 0);
      const pctN = Math.round(pct * (pct <= 1 ? 100 : 1));
      return `<div class="agent-row">
        <span class="agent-name" title="${name}">${name}</span>
        <div class="agent-bar-bg"><div class="agent-bar" style="width:${pctN}%"></div></div>
        <span class="agent-pct">${pctN}%</span>
      </div>`;
    }).join('');
  }

  if (data.last_decision) {
    html += `<div class="analysis-box"><div class="analysis-label">最新判断</div>${data.last_decision}</div>`;
  }
  el.innerHTML = html;
}

function update(data) {
  $('statusDot').className = 'status-dot' + (data.status === 'running' ? '' : ' offline');
  $('modeBadge').textContent = data.mode === 'paper' ? '模擬取引' : 'ライブ';
  animateValue($('equity'), '$' + fmt(data.equity), '');
  $('cash').textContent = '現金: $' + fmt(data.cash);
  animateValue($('pnl'), (data.total_pnl >= 0 ? '+$' : '-$') + fmt(Math.abs(data.total_pnl)), pnlClass(data.total_pnl));
  animateValue($('returnPct'), (data.return_pct >= 0 ? '+' : '') + fmt(data.return_pct) + '%', pnlClass(data.return_pct));
  const wr = data.win_rate || {};
  animateValue($('winRate'), fmt(wr.win_rate || 0, 1) + '%', '');
  $('winLoss').textContent = `${wr.wins || 0}勝 / ${wr.losses || 0}敗 (${wr.total || 0}件)`;
  renderPositions(data.open_positions);
  renderTrades(data.closed_trades);
  renderLearning(data);
  renderAnalysis(data);
  if (data.last_updated) {
    const d = new Date(data.last_updated);
    $('lastUpdated').textContent = d.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit', second:'2-digit' }) + ' 更新';
  }
}

async function fetchData() {
  try {
    const res = await fetch('/api/dashboard');
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    update(data);
    document.body.classList.remove('loading');
  } catch (e) {
    console.warn('Fetch failed:', e);
  }
}

function tick() {
  timer--;
  if (timer <= 0) { timer = INTERVAL; fetchData(); }
  $('countdown').textContent = timer + '秒後に更新';
}

fetchData();
intervalId = setInterval(tick, 1000);
</script>
</body>
</html>
